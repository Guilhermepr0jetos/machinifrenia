<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"><title>Abrir Gift Card Seguro</title>
<style>
  body{font-family:sans-serif;padding:2rem;max-width:760px;margin:auto}
</style>
</head>
<body>
<h2>üìú Abrir Gift Card Seguro</h2>

<label>Arquivo giftcard.bin:</label>
<input id="gcfile" type="file" />

<label>Arquivo de refer√™ncia (para chave):</label>
<input id="refFile" type="file" />

<button id="open">Descriptografar</button>
<pre id="out"></pre>

<script>
const enc = new TextEncoder();
const dec = new TextDecoder();

document.getElementById("open").onclick = async () => {
  const gcfile = document.getElementById("gcfile").files[0];
  const refFile = document.getElementById("refFile").files[0];
  const out = document.getElementById("out");
  out.textContent = "";

  if (!gcfile || !refFile) {
    out.textContent = "Selecione o giftcard.bin e o arquivo de refer√™ncia.";
    return;
  }

  const buf = new Uint8Array(await gcfile.arrayBuffer());
  const header = buf.slice(0, 12);
  const magic = dec.decode(header.slice(0, 4));
  if (magic !== "GFC1") { out.textContent = "Formato inv√°lido."; return; }

  const dv = new DataView(header.buffer);
  const hi = dv.getUint32(4, false);
  const lo = dv.getUint32(8, false);
  const expiresMs = hi * 2**32 + lo;
  const expiresIso = new Date(expiresMs).toISOString();
  const now = Date.now();
  if (now > expiresMs) {
    out.textContent = `‚ö†Ô∏è Gift Card expirado em ${expiresIso}`;
    return;
  }

  const iv = buf.slice(12, 24);
  const ciphertext = buf.slice(24);

  const refBuf = await refFile.arrayBuffer();
  const keyMat = await crypto.subtle.digest("SHA-256", refBuf);
  const key = await crypto.subtle.importKey("raw", keyMat, {name:"AES-GCM"}, false, ["decrypt"]);

  try {
    const plaintextBuf = await crypto.subtle.decrypt({name:"AES-GCM", iv, additionalData: header}, key, ciphertext);
    const payload = JSON.parse(dec.decode(plaintextBuf));
    out.textContent = `‚úÖ Gift Card v√°lido at√© ${expiresIso}\nConte√∫do:\n` + JSON.stringify(payload, null, 2);
  } catch(e) {
    out.textContent = "‚ùå Falha na descriptografia ou chave incorreta.";
  }
};
</script>
</body>
</html>
