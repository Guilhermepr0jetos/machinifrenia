<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<title>Criar Gift Card</title>
<style>
body { font-family: sans-serif; max-width: 800px; margin: 20px auto; }
label { display:block; margin-top: 10px; font-weight: bold; }
input, textarea, button { width: 100%; padding: 8px; margin-top: 4px; }
pre { background: #f6f8fa; padding: 8px; white-space: pre-wrap; }
</style>
</head>
<body>
<h1>🔐 Criar Gift Card</h1>

<label>Chave descartável:</label>
<input type="text" id="dispKey" placeholder="KEY-EXEMPLO-123">

<label>Data/hora de expiração (UTC):</label>
<input type="datetime-local" id="expires">

<label>Conteúdo do gift (JSON):</label>
<textarea id="payload" rows="6"></textarea>

<label>Nome do arquivo:</label>
<input type="text" id="outName" value="giftcard.bin">

<button id="gen">Gerar .bin</button>
<pre id="log"></pre>

<script>
const log = msg => document.getElementById('log').textContent += msg + "\n";
const enc = new TextEncoder();

// Busca hora UTC real de um servidor confiável
async function getServerUTC() {
  const resp = await fetch("https://worldtimeapi.org/api/timezone/America/Fortaleza");
  if (!resp.ok) throw new Error("Falha ao obter hora");
  const data = await resp.json();
  return new Date(data.datetime); // retorna objeto Date em UTC
}

async function generateBin(payloadObj, meta) {
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const key = await crypto.subtle.generateKey(
    { name: "AES-GCM", length: 256 },
    true, ["encrypt"]
  );
  const rawKey = await crypto.subtle.exportKey("raw", key);
  const aad = enc.encode(`${meta.key}|${meta.exp}`);
  const cipher = await crypto.subtle.encrypt(
    { name: "AES-GCM", iv, additionalData: aad },
    key,
    enc.encode(JSON.stringify(payloadObj))
  );
  return { cipher, iv, rawKey };
}

document.getElementById('gen').onclick = async () => {
  document.getElementById('log').textContent = "";
  try {
    const dKey = document.getElementById('dispKey').value.trim();
    const expInput = document.getElementById('expires').value;
    const payloadStr = document.getElementById('payload').value.trim();
    const outName = document.getElementById('outName').value.trim() || "giftcard.bin";
    if (!dKey || !expInput || !payloadStr) throw new Error("Preencha todos os campos");

    log("⏳ Obtendo hora UTC do servidor...");
    const serverTime = await getServerUTC();
    log("Hora do servidor: " + serverTime.toISOString());

    const expTime = new Date(expInput + "Z");
    if (serverTime > expTime) throw new Error("Data de expiração já passou segundo o servidor");

    const payload = JSON.parse(payloadStr);
    payload.exp = expTime.toISOString();

    const { cipher, iv, rawKey } = await generateBin(payload, { key: dKey, exp: payload.exp });

    const blob = new Blob([cipher], { type: "application/octet-stream" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = outName;
    a.click();

    log("✅ Gift Card gerado");
    log("🔑 Chave AES (Base64): " + btoa(String.fromCharCode(...new Uint8Array(rawKey))));
    log("📌 IV (Base64): " + btoa(String.fromCharCode(...new Uint8Array(iv))));
  } catch (err) {
    log("❌ Erro: " + err.message);
  }
};
</script>
</body>
</html>
