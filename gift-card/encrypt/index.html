<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"><title>Criar Gift Card Seguro</title>
<style>
  body{font-family:sans-serif;padding:2rem;max-width:760px;margin:auto}
  label{display:block;margin-top:1rem}
  input,textarea,button{margin-top:.25rem}
</style>
</head>
<body>
<h2>üéÅ Criar Gift Card Seguro</h2>

<label>C√≥digo do gift card (recomendado gerar aleat√≥rio):</label>
<input id="code" placeholder="ex: 32+ chars aleat√≥rios" />

<label>Valor</label>
<input id="value" type="number" min="1" value="50" />

<label>Moeda</label>
<input id="currency" value="BRL" />

<label>Validade (se vazio, usa +180 dias)</label>
<input id="expires" type="datetime-local" />

<label>Arquivo de refer√™ncia (gera a chave):</label>
<input id="refFile" type="file" />

<label>Anexo (opcional, ser√° entregue ap√≥s descriptografia):</label>
<input id="attach" type="file" />

<button id="gen">Gerar giftcard.bin</button>
<pre id="out"></pre>

<script>
const API_BASE = ""; // opcional: URL do seu backend p/ registrar (se usar registro)

const enc = new TextEncoder();
const dec = new TextDecoder();

function uuidv4(){
  return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16));
}

async function fileToBase64(file){
  const buf = await file.arrayBuffer();
  const b64 = btoa(String.fromCharCode(...new Uint8Array(buf)));
  return `data:${file.type || "application/octet-stream"};base64,${b64}`;
}

async function sha256Hex(str){
  const hash = await crypto.subtle.digest("SHA-256", enc.encode(str));
  return [...new Uint8Array(hash)].map(b=>b.toString(16).padStart(2,"0")).join("");
}

function computeExpiresMs(expiresInputValue){
  if (expiresInputValue) {
    const t = new Date(expiresInputValue).getTime();
    if (Number.isFinite(t) && t > 0) return t;
  }
  // padr√£o: +180 dias a partir de agora
  return Date.now() + 180 * 24 * 60 * 60 * 1000;
}

document.getElementById("gen").onclick = async () => {
  const code = document.getElementById("code").value.trim();
  const value = parseFloat(document.getElementById("value").value);
  const currency = document.getElementById("currency").value.trim() || "BRL";
  const expiresEl = document.getElementById("expires").value;
  const refFile = document.getElementById("refFile").files[0];
  const attach = document.getElementById("attach").files[0];
  const out = document.getElementById("out");

  out.textContent = "";

  if (!code || !refFile || !value) {
    out.textContent = "Preencha c√≥digo, valor e arquivo de refer√™ncia.";
    return;
  }

  const giftId = uuidv4();
  const expiresMs = computeExpiresMs(expiresEl);
  const expiresIso = new Date(expiresMs).toISOString();

  // Monta payload (o payload tamb√©m guarda a validade, mas a autoridade de expira√ß√£o est√° no cabe√ßalho)
  const payload = {
    giftId,
    code, // protegido pela criptografia
    meta: {
      value, currency,
      expiresAt: expiresIso
    },
    attachment: null
  };
  if (attach) {
    payload.attachment = {
      name: attach.name,
      type: attach.type || "application/octet-stream",
      base64: await fileToBase64(attach)
    };
  }

  // Deriva chave do arquivo de refer√™ncia
  const refBuf = await refFile.arrayBuffer();
  const keyMat = await crypto.subtle.digest("SHA-256", refBuf);
  const key = await crypto.subtle.importKey("raw", keyMat, {name:"AES-GCM"}, false, ["encrypt"]);

  // Cabe√ßalho: "GFC1" + expiresMs(uint64 big-endian)
  const header = new Uint8Array(12);
  header.set(new TextEncoder().encode("GFC1"), 0);
  const dv = new DataView(header.buffer);
  const hi = Math.floor(expiresMs / 2**32);
  const lo = Math.floor(expiresMs % 2**32);
  dv.setUint32(4, hi, false); // big-endian
  dv.setUint32(8, lo, false); // big-endian

  // Criptografa com IV aleat√≥rio e AAD = header
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const plaintext = enc.encode(JSON.stringify(payload));
  const ciphertext = await crypto.subtle.encrypt({name:"AES-GCM", iv, additionalData: header}, key, plaintext);

  // final = header (12) + iv (12) + ciphertext
  const final = new Uint8Array(12 + 12 + ciphertext.byteLength);
  final.set(header, 0);
  final.set(iv, 12);
  final.set(new Uint8Array(ciphertext), 24);

  // Gera arquivo
  const blob = new Blob([final], {type:"application/octet-stream"});
  const url = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement("a"), {href:url, download:`giftcard_${giftId}.bin`});
  a.click(); URL.revokeObjectURL(url);

  // (Opcional) registro no backend ‚Äî seu banco s√≥ para ATIVADOS? ent√£o mantenha desabilitado.
  // Caso queira registrar metadados n√£o sens√≠veis:
  // const codeHash = await sha256Hex(code);
  // if (API_BASE) {
  //   try {
  //     await fetch(`${API_BASE}/api/redeem/register`, {
  //       method:"POST", headers:{"Content-Type":"application/json"},
  //       body: JSON.stringify({ giftId, codeHash, value, currency, expiresAt: expiresIso })
  //     });
  //   } catch(e){}
  // }

  out.textContent = `‚úÖ Gift Card criado.
giftId=${giftId}
expira em: ${new Date(expiresMs).toLocaleString()}
Formato: [GFC1|uint64_be(expiresMs)|IV|ciphertext+tag]`;
};
</script>
</body>
</html>
```
