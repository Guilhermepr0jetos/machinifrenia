<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"><title>Criar Gift Card Seguro</title>
<style>
  body{font-family:sans-serif;padding:2rem;max-width:760px;margin:auto}
  label{display:block;margin-top:1rem}
</style>
</head>
<body>
<h2>üîê Criar Gift Card Seguro</h2>

<label>C√≥digo do gift card:</label>
<input id="code" placeholder="ex: 32+ chars aleat√≥rios" />

<label>Valor</label>
<input id="value" type="number" min="1" value="50" />

<label>Moeda</label>
<input id="currency" value="BRL" />

<label>Validade (opcional; UTC):</label>
<input id="expires" type="datetime-local" />

<label>Arquivo de refer√™ncia:</label>
<input id="refFile" type="file" />

<label>Anexo (opcional):</label>
<input id="attach" type="file" />

<button id="gen">Gerar giftcard.bin</button>
<pre id="out"></pre>

<script>
const enc = new TextEncoder();

function uuidv4(){
  return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16));
}

async function fileToBase64(file){
  const buf = await file.arrayBuffer();
  const b64 = btoa(String.fromCharCode(...new Uint8Array(buf)));
  return `data:${file.type || "application/octet-stream"};base64,${b64}`;
}

async function getTrustedNowMs(){
  const r = await fetch("http://worldtimeapi.org/api/timezone/America/Fortaleza");
  const j = await r.json();
  return j.unixtime * 1000;
}

function writeUint64BE(view, byteOffset, value){
  const hi = Math.floor(value / 2**32);
  const lo = value >>> 0;
  view.setUint32(byteOffset, hi, false);
  view.setUint32(byteOffset + 4, lo, false);
}

document.getElementById("gen").onclick = async () => {
  const code = document.getElementById("code").value.trim();
  const value = parseFloat(document.getElementById("value").value);
  const currency = document.getElementById("currency").value.trim() || "BRL";
  const expiresEl = document.getElementById("expires").value;
  const refFile = document.getElementById("refFile").files[0];
  const attach = document.getElementById("attach").files[0];
  const out = document.getElementById("out");
  out.textContent = "";

  if (!code || !refFile || !value) {
    out.textContent = "Preencha c√≥digo, valor e arquivo de refer√™ncia.";
    return;
  }

  const trustedNow = await getTrustedNowMs();
  const expiresMs = expiresEl ? new Date(expiresEl).getTime() : trustedNow + 180 * 864e5;
  const expiresIso = new Date(expiresMs).toISOString();

  const giftId = uuidv4();
  const payload = { giftId, code, meta: { value, currency, expiresAt: expiresIso }, attachment: null };
  if (attach) {
    payload.attachment = { name: attach.name, type: attach.type || "application/octet-stream", base64: await fileToBase64(attach) };
  }

  const refBuf = await refFile.arrayBuffer();
  const keyMat = await crypto.subtle.digest("SHA-256", refBuf);
  const key = await crypto.subtle.importKey("raw", keyMat, {name:"AES-GCM"}, false, ["encrypt"]);

  const header = new Uint8Array(12);
  header.set(enc.encode("GFC1"), 0);
  const dv = new DataView(header.buffer);
  writeUint64BE(dv, 4, expiresMs);

  const iv = crypto.getRandomValues(new Uint8Array(12));
  const plaintext = enc.encode(JSON.stringify(payload));
  const ciphertext = await crypto.subtle.encrypt({name:"AES-GCM", iv, additionalData: header}, key, plaintext);

  const final = new Uint8Array(24 + ciphertext.byteLength);
  final.set(header, 0);
  final.set(iv, 12);
  final.set(new Uint8Array(ciphertext), 24);

  const blob = new Blob([final], {type:"application/octet-stream"});
  const url = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement("a"), {href:url, download:`giftcard_${giftId}.bin`});
  a.click(); URL.revokeObjectURL(url);

  out.textContent = `‚úÖ Gift Card criado\nexpira: ${expiresIso}`;
};
</script>
</body>
</html>
