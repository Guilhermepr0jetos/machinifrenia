<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<title>Criar Gift Card</title>
<style>
body { font-family: sans-serif; margin: 24px; max-width: 800px; }
label { display:block; margin-top: 12px; font-weight: 600; }
input, textarea, button { width: 100%; padding: 8px; margin-top: 4px; }
pre { background: #f6f8fa; padding: 8px; }
</style>
</head>
<body>
<h1>üîê Criar Gift Card (.bin)</h1>

<label>Arquivo de refer√™ncia:</label>
<input type="file" id="refFile">

<label>Chave descart√°vel (estar√° no keys.json v√°lido):</label>
<input type="text" id="dispKey" placeholder="KEY-EXEMPLO-123">

<label>Data/hora de expira√ß√£o (UTC):</label>
<input type="datetime-local" id="expires">

<label>Conte√∫do do gift (JSON):</label>
<textarea id="payload" rows="6"></textarea>

<label>Nome do arquivo:</label>
<input type="text" id="outName" value="giftcard.bin">

<button id="gen">Gerar .bin</button>
<pre id="log"></pre>

<script>
const log = m => document.getElementById('log').textContent += m + "\n";
const toBytes = s => new TextEncoder().encode(s);
const b64e = buf => btoa(String.fromCharCode(...new Uint8Array(buf)));
async function sha256(buf) { return await crypto.subtle.digest("SHA-256", buf); }
async function readBuf(file) {
  return new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>res(fr.result);fr.onerror=rej;fr.readAsArrayBuffer(file);});
}
async function fetchKeys(){
  const r = await fetch('./keys.json', {cache:"no-store"});
  if(!r.ok) throw new Error("Falha ao ler keys.json");
  return await r.json();
}
function isKeyAllowed(db, key){
  const k = key.trim();
  const valids = new Set(db.validas||[]);
  const invalids = new Set(db.invalidas||[]);
  if(invalids.has(k)) return false;
  if(valids.size>0) return valids.has(k);
  return !invalids.has(k);
}
document.getElementById('gen').onclick = async () => {
  document.getElementById('log').textContent="";
  try{
    const refF = document.getElementById('refFile').files[0];
    const dKey = document.getElementById('dispKey').value.trim();
    const expiresVal = document.getElementById('expires').value;
    const payloadStr = document.getElementById('payload').value.trim();
    const outName = document.getElementById('outName').value.trim() || "giftcard.bin";
    if(!refF || !dKey || !payloadStr) throw new Error("Campos obrigat√≥rios faltando");

    const keysdb = await fetchKeys();
    if(!isKeyAllowed(keysdb,dKey)) throw new Error("Chave n√£o est√° v√°lida no keys.json");
    log("Chave v√°lida");

    let expMs;
    if(expiresVal){
      expMs = new Date(expiresVal).getTime();
    } else {
      expMs = Date.now() + 180*864e5; // 180 dias
    }
    const expIso = new Date(expMs).toISOString();

    const payload = JSON.parse(payloadStr);
    payload.exp = expIso;

    const refBuf = await readBuf(refF);
    const refHash = await sha256(refBuf);

    const salt = crypto.getRandomValues(new Uint8Array(16));
    const baseKey = await crypto.subtle.importKey("raw",refHash,"HKDF",false,["deriveKey"]);
    const aesKey = await crypto.subtle.deriveKey({name:"HKDF",hash:"SHA-256",salt,info:toBytes("giftcard-v1")}, baseKey, {name:"AES-GCM",length:256}, false, ["encrypt"]);
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const aad = toBytes(dKey+"|"+expIso);

    const ct = await crypto.subtle.encrypt({name:"AES-GCM",iv,additionalData:aad},aesKey,toBytes(JSON.stringify(payload)));

    const artifact = {v:1,salt:b64e(salt),iv:b64e(iv),exp:expIso,ct:b64e(ct)};
    const blob = new Blob([JSON.stringify(artifact)],{type:"application/octet-stream"});
    const a = document.createElement('a');a.href=URL.createObjectURL(blob);a.download=outName;a.click();URL.revokeObjectURL(a.href);
    log("‚úÖ Gift card criado com expira√ß√£o "+expIso);
  }catch(e){ log("Erro: "+e.message); }
};
</script>
</body>
</html>
