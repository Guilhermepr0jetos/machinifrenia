<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<title>Abrir Gift Card</title>
<style>
body { font-family: sans-serif; margin: 24px; max-width: 800px; }
label { display:block; margin-top: 12px; font-weight: 600; }
input, button { width: 100%; padding: 8px; margin-top: 4px; }
pre { background: #f6f8fa; padding: 8px; white-space: pre-wrap; }
</style>
</head>
<body>
<h1>üìú Abrir Gift Card (.bin)</h1>

<label>Arquivo .bin:</label>
<input type="file" id="binFile">

<label>Arquivo de refer√™ncia:</label>
<input type="file" id="refFile">

<label>Chave descart√°vel:</label>
<input type="text" id="dispKey">

<button id="open">Abrir</button>
<pre id="log"></pre>

<script>
const log = m => document.getElementById('log').textContent += m + "\n";
const toBytes = s => new TextEncoder().encode(s);
const fromBytes = b => new TextDecoder().decode(b);
const b64d = b64 => Uint8Array.from(atob(b64),c=>c.charCodeAt(0)).buffer;

async function sha256(buf){ return await crypto.subtle.digest("SHA-256",buf); }
async function readBuf(file){ return new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>res(fr.result);fr.onerror=rej;fr.readAsArrayBuffer(file);}); }
async function readText(file){ return new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>res(fr.result);fr.onerror=rej;fr.readAsText(file);}); }
async function fetchKeys(){ const r=await fetch('https://machinifrenia.vercel.app/gift-card/Keys.json',{cache:"no-store"}); if(!r.ok) throw new Error("Falha ao ler keys.json"); return await r.json(); }
function isKeyAllowed(db,key){ const k=key.trim(); const valids=new Set(db.validas||[]); const invalids=new Set(db.invalidas||[]); if(invalids.has(k)) return false; if(valids.size>0) return valids.has(k); return !invalids.has(k); }
async function getUtcNow(){ const r=await fetch("https://worldtimeapi.org/api/timezone/America/Fortaleza",{cache:"no-store"}); if(!r.ok) throw new Error("Falha ao obter hora UTC"); const j=await r.json(); return new Date(j.utc_datetime); }

document.getElementById('open').onclick = async ()=>{
  document.getElementById('log').textContent="";
  try{
    const binF = document.getElementById('binFile').files[0];
    const refF = document.getElementById('refFile').files[0];
    const dKey = document.getElementById('dispKey').value.trim();
    if(!binF || !refF || !dKey) throw new Error("Campos obrigat√≥rios faltando");

    const keysdb = await fetchKeys();
    if(!isKeyAllowed(keysdb,dKey)) throw new Error("Chave inv√°lida no keys.json");
    log("Chave v√°lida local");

    const txt = await readText(binF);
    const art = JSON.parse(txt);
    if(art.v !== 1) throw new Error("Vers√£o n√£o suportada");

    // Verifica expira√ß√£o via hora real
    log("Obtendo hora UTC da API...");
    const now = await getUtcNow();
    const exp = new Date(art.exp);
    if(now > exp) throw new Error(`Gift expirado em ${exp.toISOString()}`);
    log(`Gift v√°lido at√© ${exp.toISOString()}`);

    // Deriva a chave com base no arquivo de refer√™ncia
    const refBuf = await readBuf(refF);
    const refHash = await sha256(refBuf);
    const salt = b64d(art.salt);
    const baseKey = await crypto.subtle.importKey("raw",refHash,"HKDF",false,["deriveKey"]);
    const aesKey = await crypto.subtle.deriveKey({name:"HKDF",hash:"SHA-256",salt:new Uint8Array(salt),info:toBytes("giftcard-v1")}, baseKey, {name:"AES-GCM",length:256}, false, ["decrypt"]);
    
    const iv = new Uint8Array(b64d(art.iv));
    const aad = toBytes(dKey+"|"+art.exp);
    const ct = b64d(art.ct);

    const ptBuf = await crypto.subtle.decrypt({name:"AES-GCM",iv,additionalData:aad}, aesKey, ct);
    const payload = JSON.parse(fromBytes(ptBuf));
    log("üéÅ Conte√∫do do gift card:");
    log(JSON.stringify(payload,null,2));

  }catch(e){
    log("Erro: "+e.message);
  }
};
</script>
</body>
</html>
